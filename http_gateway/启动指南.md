# Lumi Pilot HTTP 网关 - 启动指南

> **注意**：这是一个临时测试用的 HTTP 网关模块，后期可以完全删除，不会影响主项目。

---

## 📋 目录

1. [项目介绍](#项目介绍)
2. [前置要求](#前置要求)
3. [快速开始](#快速开始)
4. [详细启动步骤](#详细启动步骤)
5. [验证服务](#验证服务)
6. [常见问题](#常见问题)
7. [如何删除](#如何删除)

---

## 项目介绍

**Lumi Pilot HTTP 网关**是一个独立的 HTTP-to-gRPC 适配器，用于为现有的 gRPC 服务提供 HTTP/REST 接口。

### 架构图

```
外部客户端（浏览器、Postman等）
    ↓ HTTP/JSON 请求
HTTP 网关（FastAPI，端口 8000）
    ↓ gRPC Protobuf 调用
Lumi Pilot gRPC 服务器（端口 50051）
    ↓
核心服务（Chat、PrinterMonitoring 等）
```

### 特点

- ✅ **完全独立** - 不修改主项目任何代码
- ✅ **易于删除** - 临时测试用，删除整个目录即可
- ✅ **自动文档** - 访问 `/docs` 获取 Swagger UI
- ✅ **健康检查** - 实时监控后端 gRPC 状态

---

## 前置要求

### 1. 软件依赖

- **Python**: 3.12 或更高版本
- **uv**: Python 包管理工具（项目使用 uv 管理依赖）
- **主项目运行正常**: 确保 Lumi Pilot 主项目可以正常启动

### 2. 检查 uv 是否安装

```bash
uv --version
```

如果未安装，请参考：https://github.com/astral-sh/uv

---

## 快速开始

### 一键启动（3 步）

```bash
# 1. 进入网关目录并安装依赖
cd /path/to/lumi-pilot/http_gateway
uv sync

# 2. 打开两个终端窗口

# 【终端 1】启动主项目 gRPC 服务器
cd /path/to/lumi-pilot
uv run python main.py

# 【终端 2】启动 HTTP 网关
cd /path/to/lumi-pilot/http_gateway
uv run python -m http_gateway.server

# 3. 访问 http://localhost:8000/docs
```

---

## 详细启动步骤

### 步骤 1：安装依赖（首次使用）

```bash
cd /path/to/lumi-pilot/http_gateway
uv sync
```

**预期输出：**
```
Resolved 26 packages in 2.61s
Installed 25 packages in 30ms
 + fastapi==0.121.2
 + uvicorn==0.38.0
 + grpcio==1.76.0
 ...
```

---

### 步骤 2：启动 gRPC 服务器

**⚠️ 重要**：必须**先启动** gRPC 服务器，否则 HTTP 网关无法连接。

#### 方式 A：使用 uv（推荐）

```bash
cd /path/to/lumi-pilot
uv run python main.py
```

#### 方式 B：直接运行（如果已激活虚拟环境）

```bash
cd /path/to/lumi-pilot
python main.py
```

**预期输出：**
```
[info] [grpc_server] gRPC服务器启动成功
[info] [grpc_server] 监听地址: localhost:50051
[info] [grpc_server] 等待客户端连接...
```

**保持这个终端运行**，不要关闭！

---

### 步骤 3：启动 HTTP 网关

打开**新的终端窗口**：

#### 方式 A：基础启动（推荐用于生产）

```bash
cd /path/to/lumi-pilot/http_gateway
uv run python -m http_gateway.server
```

#### 方式 B：带热重载（推荐用于开发）

代码修改后自动重启服务器：

```bash
cd /path/to/lumi-pilot/http_gateway
uv run uvicorn http_gateway.server:app --host 0.0.0.0 --port 8000 --reload
```

**预期输出：**
```
============================================================
  Lumi Pilot HTTP Gateway
============================================================
  HTTP 服务器: http://0.0.0.0:8000
  API 文档: http://0.0.0.0:8000/docs
  健康检查: http://0.0.0.0:8000/health
============================================================

INFO:     Started server process [12345]
INFO:     Waiting for application startup.
[HTTP Gateway] 已配置 gRPC 目标: localhost:50051
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
```

**保持这个终端运行**，服务正常启动！

---

### 步骤 4：配置环境变量（可选）

如果需要自定义配置：

```bash
# gRPC 服务器地址（默认 localhost:50051）
export GRPC_HOST=localhost
export GRPC_PORT=50051

# HTTP 服务器配置（默认 0.0.0.0:8000）
export HTTP_HOST=0.0.0.0
export HTTP_PORT=8000

# 然后启动
uv run python -m http_gateway.server
```

---

## 验证服务

### 1. 检查服务是否启动

访问根路径：

```bash
curl http://localhost:8000/
```

**预期响应：**
```json
{
  "service": "Lumi Pilot HTTP Gateway",
  "version": "0.1.0",
  "status": "running",
  "docs": "/docs",
  "health": "/health"
}
```

---

### 2. 健康检查

```bash
curl http://localhost:8000/health
```

**预期响应（正常）：**
```json
{
  "status": "healthy",
  "http_gateway": "running",
  "grpc_backend": "connected",
  "grpc_target": "localhost:50051",
  "timestamp": "2025-11-14T14:30:00.123456"
}
```

**异常响应（gRPC 未启动）：**
```json
{
  "status": "unhealthy",
  "http_gateway": "running",
  "grpc_backend": "disconnected",
  "grpc_target": "localhost:50051",
  "timestamp": "2025-11-14T14:30:00.123456"
}
```

如果显示 `"grpc_backend": "disconnected"`，请检查 gRPC 服务器是否已启动（步骤 2）。

---

### 3. 测试 API 接口

#### 访问 Swagger 文档（推荐）

在浏览器中打开：

```
http://localhost:8000/docs
```

你会看到完整的 API 文档，可以直接在页面上测试所有接口！

#### 使用 cURL 测试

**AI 对话接口：**

```bash
curl -X POST http://localhost:8000/api/chat \
  -H "Content-Type: application/json" \
  -d '{"message": "你好，Lumi Pilot"}'
```

**预期响应：**
```json
{
  "success": true,
  "message": "你好！我是Lumi Pilot AI助手，很高兴为你服务。",
  "error": null,
  "metadata": {
    "request_id": "550e8400-e29b-41d4-a716-446655440000",
    "model": "Pro/deepseek-ai/DeepSeek-V3",
    "duration": 2.35,
    "timestamp": "2025-11-14T14:30:02.456789"
  }
}
```

**打印机监控接口：**

```bash
curl -X POST http://localhost:8000/api/monitor-printer \
  -H "Content-Type: application/json" \
  -d '{}'
```

---

### 4. 运行自动化测试脚本

```bash
cd /path/to/lumi-pilot/http_gateway
uv run python tests/test_api.py
```

**预期输出：**
```
============================================================
  Lumi Pilot HTTP Gateway 测试
============================================================

[测试 1] 根路径 GET /
------------------------------------------------------------
状态码: 200
响应: {'service': 'Lumi Pilot HTTP Gateway', ...}

[测试 2] 健康检查 GET /health
------------------------------------------------------------
状态码: 200
服务状态: healthy
...

============================================================
  测试结果汇总
============================================================
根路径                 ✅ 通过
健康检查               ✅ 通过
AI 对话                ✅ 通过
打印机监控             ✅ 通过

总计: 4/4 通过
```

---

## 常见问题

### Q1: 提示 "Address already in use"

**问题：** 端口 8000 被占用。

**解决方案：**

```bash
# 查找占用端口的进程
lsof -i :8000

# 杀死占用进程
lsof -ti:8000 | xargs kill -9

# 或使用其他端口
HTTP_PORT=9000 uv run python -m http_gateway.server
```

---

### Q2: 提示 "ModuleNotFoundError: No module named 'generated'"

**问题：** 依赖未正确安装。

**解决方案：**

```bash
cd /path/to/lumi-pilot/http_gateway
uv sync
```

---

### Q3: 健康检查显示 "grpc_backend: disconnected"

**问题：** gRPC 服务器未启动或未监听在 50051 端口。

**解决方案：**

1. 检查 gRPC 服务器是否运行：
   ```bash
   lsof -i :50051
   ```

2. 如果没有输出，说明 gRPC 服务器未启动，请先启动：
   ```bash
   cd /path/to/lumi-pilot
   uv run python main.py
   ```

3. 检查 gRPC 服务器日志是否有错误。

---

### Q4: 如何在后台运行服务？

**方案 A：使用 nohup**

```bash
# gRPC 服务器
cd /path/to/lumi-pilot
nohup uv run python main.py > grpc.log 2>&1 &

# HTTP 网关
cd /path/to/lumi-pilot/http_gateway
nohup uv run python -m http_gateway.server > http.log 2>&1 &
```

**方案 B：使用 screen**

```bash
# 创建 gRPC 会话
screen -S grpc
cd /path/to/lumi-pilot && uv run python main.py
# 按 Ctrl+A, D 退出会话

# 创建 HTTP 会话
screen -S http
cd /path/to/lumi-pilot/http_gateway && uv run python -m http_gateway.server
# 按 Ctrl+A, D 退出会话

# 查看会话列表
screen -ls

# 重新连接会话
screen -r grpc
screen -r http
```

---

### Q5: 如何查看日志？

**实时查看：**

服务器会直接输出日志到终端。

**保存到文件：**

```bash
uv run python -m http_gateway.server 2>&1 | tee http_gateway.log
```

---

### Q6: 如何更改端口？

**临时更改（仅本次）：**

```bash
HTTP_PORT=9000 uv run python -m http_gateway.server
```

**永久更改：**

创建 `.env` 文件：

```bash
echo "HTTP_PORT=9000" > .env
```

然后正常启动。

---

## 停止服务

### 正常停止

在运行服务器的终端中按 `Ctrl+C`。

### 强制停止

```bash
# 停止 HTTP 网关
lsof -ti:8000 | xargs kill -9

# 停止 gRPC 服务器
lsof -ti:50051 | xargs kill -9
```

---

## 如何删除

当不再需要 HTTP 网关时：

```bash
# 停止所有服务（如果在运行）
lsof -ti:8000 | xargs kill -9

# 删除整个目录
cd /path/to/lumi-pilot
rm -rf http_gateway/
```

**主项目完全不受影响**，因为：
- HTTP 网关是独立的 uv 项目
- 使用符号链接引用主项目代码，无侵入性
- 删除后主项目可正常运行

---

## 技术支持

- **项目文档**: 查看 `README.md` 了解详细信息
- **API 文档**: http://localhost:8000/docs
- **主项目文档**: 查看主项目的 `AGENTS.md` 和 `README.md`

---

## 快速参考

### 启动命令

```bash
# 主项目 gRPC 服务器
cd /path/to/lumi-pilot && uv run python main.py

# HTTP 网关
cd /path/to/lumi-pilot/http_gateway && uv run python -m http_gateway.server
```

### 重要 URL

- **HTTP 服务**: http://localhost:8000/
- **API 文档**: http://localhost:8000/docs
- **健康检查**: http://localhost:8000/health

### 测试命令

```bash
# 健康检查
curl http://localhost:8000/health

# AI 对话
curl -X POST http://localhost:8000/api/chat \
  -H "Content-Type: application/json" \
  -d '{"message": "测试消息"}'

# 自动化测试
uv run python tests/test_api.py
```

---

**祝使用愉快！** 🎉
